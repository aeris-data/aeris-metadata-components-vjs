<i18n>
{
  "en": {
    "loading": "Loading..."
  },
  "fr": {
    "loading": "Chargement"
  }
}
</i18n>
<template>
  <section v-if="visible" class="aeris-metadata-host">
    <div id="aerisMetadataContent" class="aeris-metadata_content grid"><slot /></div>
  </section>
</template>

<script>
import { computeUuid } from "aeris-commons-components-vjs/src/lib/modules/aeris-notification/utils/utils.js";
export default {
  name: "aeris-metadata-services",

  props: {
    lang: {
      type: String,
      default: "en"
    },
    visible: {
      type: Boolean,
      default: true
    },
    service: {
      type: String,
      default: ""
    },
    identifier: {
      type: String,
      default: ""
    },
    program: {
      type: String,
      default: ""
    }
  },

  data() {
    return {
      currentMetadata: null
    };
  },

  watch: {
    lang(value) {
      this.$i18n.locale = value;
    },

    identifier() {
      this.refresh();
    },
    service() {
      this.refresh();
    },
    currentMetadata(value) {
      this.$emit("metadata", value);
    }
  },

  mounted() {
    this.$i18n.locale = this.lang;
    this.refresh();
  },

  methods: {
    refresh() {
      if (this.service && this.identifier) {
        let url;
        if (this.service.endsWith("/")) {
          url = this.service + this.identifier;
        } else {
          url = this.service + "/" + this.identifier;
        }
        let uuid = computeUuid();
        let notification = {
          message: this.$i18n.t("loading"),
          type: "wait",
          uuid: uuid
        };

        this.$emit("notification", notification);
        this.$http.get(url).then(
          response => {
            this.handleSuccess(response, uuid);
          },
          error => {
            this.handleError(error, uuid);
          }
        );
      }
    },

    handleSuccess(response, uuid) {
      this.$emit("notification", { message: "", uuid: uuid });
      this.currentMetadata = response.data;
    },

    handleError(error, uuid) {
      this.$emit("notification", { message: "", uuid: uuid });
      this.currentMetadata = null;
      console.log("Aeris-Metadata - Error while accessing server:");
      let err = error.status;
      let message = error.statusText;
      if (!err) message = "Can't connect to the server";
      console.log("Error " + err + ": " + message);
    }
  }
};
</script>

<style scoped>
.aeris-metadata-host {
  display: block;
  font-size: 14px;
}

.aeris-metadata-host * {
  box-sizing: border-box;
}
</style>
